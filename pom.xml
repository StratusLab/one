<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
  
  <modelVersion>4.0.0</modelVersion>
  
  <groupId>eu.stratuslab.pkgs</groupId>
  <artifactId>one</artifactId>
  
  <packaging>rpm</packaging>
  <version>2.0-StratusLab.SNAPSHOT</version>
  <name>OpenNebula</name>
  <url>http://stratuslab.eu</url>

  <parent>
    <groupId>eu.stratuslab.pkgs</groupId>
    <artifactId>pkgs</artifactId>
    <version>1.0-SNAPSHOT</version>
  </parent>
  
  <scm>
    <connection>scm:git:git://opennebula.org/one.git</connection>
    <developerConnection>scm:git:git://opennebula.org/one.git</developerConnection>
  </scm>

  <profiles>
    <profile>
      <activation>
	<file>
	  <exists>/bin/rpm</exists>
	</file>
      </activation>
      <build>
	<plugins>
	  <plugin>
	    <groupId>org.codehaus.mojo</groupId>
	    <artifactId>rpm-maven-plugin</artifactId>
	    <extensions>true</extensions>
	    <executions>
	      <execution>
		<goals>
		  <goal>rpm</goal>
		</goals>
	      </execution>
	    </executions>
	  </plugin>
	</plugins>
      </build>
    </profile>
    
  </profiles>

  <build>
    <plugins>

      <plugin>
	<groupId>org.apache.maven.plugins</groupId>
	<artifactId>maven-scm-plugin</artifactId>
	<configuration>
          <connectionType>connection</connectionType>
	</configuration>
	<executions>
	  <execution>
	    <id>checkout-one</id>
	    <phase>generate-sources</phase>
	    <goals>
	      <goal>checkout</goal>
	    </goals>
	    <configuration>
	      <scmVersion>one-2.0</scmVersion>
	      <scmVersionType>tag</scmVersionType>
	    </configuration>
	  </execution>
	</executions>
      </plugin>

      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-patch-plugin</artifactId>
	<executions>
	  <execution>
	    <id>apply-one-patches</id>
	    <goals>
	      <goal>apply</goal>
	    </goals>
	    <configuration>
	      <targetDirectory>${project.build.directory}/checkout</targetDirectory>
	      <strip>1</strip>
	      <naturalOrderProcessing>true</naturalOrderProcessing>
	      <optimizations>false</optimizations>
	    </configuration>
	  </execution>
	</executions>
      </plugin>

      <plugin>
	<groupId>org.codehaus.mojo</groupId>
	<artifactId>exec-maven-plugin</artifactId>
	<executions>

	  <execution>
	    <id>one-scons</id>
	    <phase>compile</phase>
	    <goals>
              <goal>exec</goal>
	    </goals>
	    <configuration>
	      <executable>scons</executable>
	      <workingDirectory>${project.build.directory}/checkout</workingDirectory>
	    </configuration>
          </execution>

	  <execution>
	    <id>one-install</id>
	    <phase>compile</phase>
	    <goals>
              <goal>exec</goal>
	    </goals>
	    <configuration>
	      <executable>${project.build.directory}/checkout/install.sh</executable>
	      <workingDirectory>${project.build.directory}/checkout</workingDirectory>
	      <arguments>
	        <argument>-d</argument>
	        <argument>${project.build.directory}/one-install</argument>
	      </arguments>
	    </configuration>
          </execution>

        </executions>
      </plugin>

      <plugin>
	<groupId>org.codehaus.mojo</groupId>
	<artifactId>rpm-maven-plugin</artifactId>
	<configuration>
	  <release>${RELEASE}</release>
	  <summary>OpenNebula</summary>
	  <name>one</name>
	  <group>System</group>
	  <vendor>StratusLab</vendor>
	  <packager>StratusLab</packager>
	  <copyright>Apache</copyright>
	  <url>http://opennebula.org/</url>
	  <provides>
	    <provide>opennebula</provide>
	    <provide>one</provide>
	  </provides>
	  <requires>
	    <require>openssl</require>
	    <require>xmlrpc-c</require>
	    <require>ruby</require>
	    <require>sqlite &gt; 3.7</require>
	  </requires>
	  <needarch>x86_64</needarch>
	  <description>
OpenNebula is a Virtual Infrastructure Manager that orchestrates storage,
network and virtualization technologies to enable the dynamic placement of
multi-tier services (groups of interconnected virtual machines) on distributed
infrastructures, combining both data center resources and remote cloud
resources, according to allocation policies. OpenNebula provides internal and
Cloud administration and user interfaces for the full management of the Cloud
platform.

OpenNebula is free software released under the Apache License.
	  </description>
	  <preinstallScriptlet>
	    <script>
installroot=${one.install.root}
mkdir -p $${installroot}
/usr/sbin/groupadd -f cloud
if ! grep -q oneadmin /etc/passwd
then
        /usr/sbin/useradd -d $${installroot} -g cloud -s /bin/bash oneadmin 2&gt;/dev/null
fi

authdir=$${installroot}/.one
file=$${authdir}/one_auth

mkdir -p $${authdir}

if [ ! -e $${file} ]; then
  password=`base64 &lt; /dev/urandom | tr -d '+/\r\n0-9' | head -c 8`
  echo "oneadmin:$${password}" &gt; $${file}
fi

if [ -e $${authdir} ]; then
  chown oneadmin:cloud $${authdir}
  chmod 0700 $${authdir}
fi

if [ -e $${file} ]; then
  chown oneadmin:cloud $${file}
  chmod 0600 $${file}
fi
	    </script>
	  </preinstallScriptlet>
	  <postinstallScriptlet>
	    <script>/sbin/ldconfig</script>
	  </postinstallScriptlet>
	  <postremoveScriptlet>
	    <script>/sbin/ldconfig</script>
	  </postremoveScriptlet>
 	  <mappings>

	    <mapping>
	      <directory>/var/one/images</directory>
	      <filemode>755</filemode>
	      <username>oneadmin</username>
	      <groupname>cloud</groupname>
	    </mapping>

	    <mapping>
	      <directory>/var/one/vms</directory>
	      <filemode>755</filemode>
	      <username>oneadmin</username>
	      <groupname>cloud</groupname>
	    </mapping>

	    <mapping>
	      <directory>${one.install.root}/bin</directory>
	      <filemode>755</filemode>
	      <username>root</username>
	      <groupname>root</groupname>
	      <directoryIncluded>false</directoryIncluded>
	      <sources>
		<source>
		  <location>target/one-install/bin</location>
		  <includes>
		    <include>**/*</include>
		  </includes>
		</source>
	      </sources>
	    </mapping>

	    <mapping>
	      <directory>/etc/init.d/</directory>
	      <filemode>755</filemode>
	      <username>root</username>
	      <groupname>root</groupname>
	      <directoryIncluded>false</directoryIncluded>
	      <sources>
		<source>
		  <location>src/main/scripts</location>
		  <includes>
		    <include>oned</include>
		  </includes>
		</source>
	      </sources>
	    </mapping>

	    <mapping>
	      <directory>${one.install.root}/etc</directory>
	      <filemode>655</filemode>
	      <username>root</username>
	      <groupname>root</groupname>
	      <configuration>true</configuration>
	      <directoryIncluded>false</directoryIncluded>
	      <sources>
		<source>
		  <location>target/one-install/etc</location>
		  <includes>
		    <include>**/*</include>
		  </includes>
		</source>
	      </sources>
	    </mapping>

	    <mapping>
	      <directory>${one.install.root}/lib</directory>
	      <filemode>755</filemode>
	      <username>root</username>
	      <groupname>root</groupname>
	      <directoryIncluded>false</directoryIncluded>
	      <sources>
		<source>
		  <location>target/one-install/lib</location>
		  <includes>
		    <include>**/*</include>
		  </includes>
		</source>
	      </sources>
	    </mapping>

	    <mapping>
	      <directory>${one.install.root}/share</directory>
	      <filemode>644</filemode>
	      <username>root</username>
	      <groupname>root</groupname>
	      <directoryIncluded>false</directoryIncluded>
	      <documentation>true</documentation>
	      <sources>
		<source>
		  <location>target/one-install/share</location>
		  <includes>
		    <include>**/*</include>
		  </includes>
		</source>
	      </sources>
	    </mapping>

	    <mapping>
	      <directory>${one.install.root}/var</directory>
	      <filemode>755</filemode>
	      <username>oneadmin</username>
	      <groupname>cloud</groupname>
	      <directoryIncluded>true</directoryIncluded>
	    </mapping>

	    <mapping>
	      <directory>${one.install.root}/var/images</directory>
	      <filemode>755</filemode>
	      <username>oneadmin</username>
	      <groupname>cloud</groupname>
	      <directoryIncluded>true</directoryIncluded>
	    </mapping>

	  </mappings>
	</configuration>
      </plugin>

    </plugins>
  </build>

  <properties>
    <maven.build.timestamp.format>yyyyMMdd.HHmmss</maven.build.timestamp.format>
    <RELEASE>StratusLab.0.${maven.build.timestamp}</RELEASE>
    <one.install.root>/srv/cloud/one</one.install.root>
  </properties>

</project>
